---
- hosts: localhost
  connection: local
  become: true
  tasks:
    # CRITICAL: Configure /etc/hosts BEFORE installing Proxmox
    # Proxmox requires hostname to resolve to a non-loopback IP
    - name: Get default IPv4 address
      set_fact:
        pve_ip: "{{ ansible_default_ipv4.address }}"
        pve_hostname: "{{ ansible_hostname }}"
        pve_fqdn: "{{ ansible_fqdn }}"

    - name: Configure /etc/hosts for Proxmox installation
      lineinfile:
        dest: /etc/hosts
        # Remove any existing entries for this hostname/fqdn
        regexp: "^\\s*[0-9a-f:.]+\\s+(.*\\s)?({{ pve_fqdn | regex_escape() }}|{{ pve_hostname | regex_escape() }})(\\s+.*|\\s*)$"
        line: "{{ pve_ip }} {{ pve_fqdn }} {{ pve_hostname }}"
        backup: yes
      when: pve_ip is defined

    - name: Proxmox deb822 repo
      deb822_repository:
        name: proxmox
        types: deb
        uris: http://download.proxmox.com/debian/pve
        suites: trixie
        components: pve-no-subscription
        architectures: amd64
        signed_by: https://enterprise.proxmox.com/debian/proxmox-release-trixie.gpg

    - name: Update package cache
      apt:
        update_cache: true

    # Preconfigure postfix to avoid interactive prompts during installation
    - name: Preconfigure postfix (no configuration)
      debconf:
        name: postfix
        question: postfix/main_mailer_type
        value: "No configuration"
        vtype: select

    - name: Preconfigure postfix mailname
      debconf:
        name: postfix
        question: postfix/mailname
        value: "{{ pve_fqdn }}"
        vtype: string

    # Install Proxmox kernel first
    - name: Install Proxmox kernel
      apt:
        name: proxmox-default-kernel
        state: present

    - name: Install Proxmox VE and dependencies
      apt:
        name:
          - proxmox-ve
          - postfix
          - open-iscsi
          - chrony
          - cloud-init
          - netplan.io
          - grub-cloud-amd64
          - grub-efi-amd64
        state: present

    # Remove os-prober (not needed for hypervisor)
    - name: Remove os-prober
      apt:
        name: os-prober
        state: absent

    # Remove standard Debian kernel (keep only Proxmox kernel)
    - name: Remove standard Debian kernel
      apt:
        name:
          - "linux-image-amd64"
          - "linux-image-6.12*"
        state: absent
        autoremove: yes
      ignore_errors: yes

    # Cloud-init configuration for Proxmox compatibility
    # Three-pronged approach to fix /etc/hosts:
    # 1. Disable cloud-init's manage_etc_hosts
    # 2. Modify the hosts template to remove 127.0.1.1 line
    # 3. Use bootcmd to dynamically add correct IP mapping

    - name: Override MAAS manage_etc_hosts for Proxmox compatibility
      copy:
        dest: /etc/cloud/cloud.cfg.d/99-proxmox.cfg
        content: |
          # Disable cloud-init hosts management for Proxmox compatibility
          # Proxmox requires hostname to resolve to actual IP, not 127.0.1.1
          manage_etc_hosts: false
        mode: '0644'

    - name: Modify cloud-init hosts template to remove 127.0.1.1 line
      copy:
        dest: /etc/cloud/templates/hosts.debian.tmpl
        content: |
          ## template:jinja
          127.0.0.1 localhost

          # The following lines are desirable for IPv6 capable hosts
          ::1 ip6-localhost ip6-loopback
          fe00::0 ip6-localnet
          ff00::0 ip6-mcastprefix
          ff02::1 ip6-allnodes
          ff02::2 ip6-allrouters
        mode: '0644'

    - name: Add cloud-init bootcmd to fix /etc/hosts with actual IP
      copy:
        dest: /etc/cloud/cloud.cfg.d/98-proxmox-hosts.cfg
        content: |
          # Proxmox requires hostname to resolve to non-loopback IP
          # This bootcmd runs early in boot to add the correct IP mapping
          bootcmd:
            - |
              IP=$(ip -4 addr show | grep 'inet ' | grep -v '127.0.0.1' | head -1 | awk '{print $2}' | cut -d/ -f1)
              HOSTNAME=$(hostname -s)
              FQDN=$(hostname -f 2>/dev/null || echo "${HOSTNAME}.localdomain")
              if [ -n "$IP" ] && [ -n "$HOSTNAME" ]; then
                sed -i '/^127\.0\.1\.1/d' /etc/hosts
                grep -q "^${IP}" /etc/hosts || echo "${IP} ${FQDN} ${HOSTNAME}" >> /etc/hosts
              fi
        mode: '0644'