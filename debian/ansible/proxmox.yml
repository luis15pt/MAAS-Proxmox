---
- hosts: localhost
  connection: local
  become: true
  tasks:
    # CRITICAL: Configure /etc/hosts BEFORE installing Proxmox
    # Proxmox requires hostname to resolve to a non-loopback IP
    - name: Get default IPv4 address
      set_fact:
        pve_ip: "{{ ansible_default_ipv4.address }}"
        pve_hostname: "{{ ansible_hostname }}"
        pve_fqdn: "{{ ansible_fqdn }}"

    - name: Configure /etc/hosts for Proxmox installation
      lineinfile:
        dest: /etc/hosts
        # Remove any existing entries for this hostname/fqdn
        regexp: "^\\s*[0-9a-f:.]+\\s+(.*\\s)?({{ pve_fqdn | regex_escape() }}|{{ pve_hostname | regex_escape() }})(\\s+.*|\\s*)$"
        line: "{{ pve_ip }} {{ pve_fqdn }} {{ pve_hostname }}"
        backup: yes
      when: pve_ip is defined

    - name: Proxmox deb822 repo
      deb822_repository:
        name: proxmox
        types: deb
        uris: http://download.proxmox.com/debian/pve
        suites: trixie
        components: pve-no-subscription
        architectures: amd64
        signed_by: https://enterprise.proxmox.com/debian/proxmox-release-trixie.gpg

    - name: Update package cache
      apt:
        update_cache: true

    # Preconfigure postfix to avoid interactive prompts during installation
    - name: Preconfigure postfix (no configuration)
      debconf:
        name: postfix
        question: postfix/main_mailer_type
        value: "No configuration"
        vtype: select

    - name: Preconfigure postfix mailname
      debconf:
        name: postfix
        question: postfix/mailname
        value: "{{ pve_fqdn }}"
        vtype: string

    # Install Proxmox kernel first
    - name: Install Proxmox kernel
      apt:
        name: proxmox-default-kernel
        state: present

    - name: Install Proxmox VE and dependencies
      apt:
        name:
          - proxmox-ve
          - postfix
          - open-iscsi
          - chrony
          - cloud-init
          - netplan.io
          - grub-cloud-amd64
          - grub-efi-amd64
        state: present

    # Remove os-prober (not needed for hypervisor)
    - name: Remove os-prober
      apt:
        name: os-prober
        state: absent

    # Remove standard Debian kernel (keep only Proxmox kernel)
    - name: Remove standard Debian kernel
      apt:
        name:
          - "linux-image-amd64"
          - "linux-image-6.12*"
        state: absent
        autoremove: yes
      ignore_errors: yes

    # Cloud-init configuration for Proxmox compatibility
    # Override MAAS's manage_etc_hosts: true setting
    - name: Override MAAS manage_etc_hosts for Proxmox compatibility
      copy:
        dest: /etc/cloud/cloud.cfg.d/99-proxmox.cfg
        content: |
          # Override MAAS manage_etc_hosts setting for Proxmox compatibility
          # Proxmox requires hostname to resolve to actual IP, not 127.0.1.1
          # MAAS sets manage_etc_hosts: true in 90_dpkg_local_cloud_config.cfg
          # This file (99) loads after and overrides that setting
          manage_etc_hosts: false
        mode: '0644'

    # Systemd service to fix /etc/hosts after cloud-init
    - name: Create script to fix /etc/hosts for Proxmox
      copy:
        dest: /usr/local/bin/fix-proxmox-hosts.sh
        mode: '0755'
        content: |
          #!/bin/bash
          # Fix /etc/hosts for Proxmox after MAAS deployment
          # Proxmox requires hostname to resolve to actual IP, not 127.0.1.1

          # Wait for network to be fully up
          sleep 5

          HOSTNAME=$(hostname -s)
          FQDN=$(hostname -f)
          # Get first non-loopback IPv4 address
          IP=$(ip -4 addr show | grep -oP '(?<=inet\s)\d+(\.\d+){3}' | grep -v '^127\.' | head -1)

          if [ -n "$IP" ] && [ -n "$FQDN" ] && [ -n "$HOSTNAME" ]; then
              echo "Fixing /etc/hosts: ${IP} ${FQDN} ${HOSTNAME}"

              # Backup original
              cp /etc/hosts /etc/hosts.backup

              # Remove any existing entries for this hostname
              sed -i "/\s${HOSTNAME}\(\s\|$\)/d" /etc/hosts

              # Add correct entry at the top (after comments)
              sed -i "1a ${IP} ${FQDN} ${HOSTNAME}" /etc/hosts

              # Ensure localhost entries exist
              grep -q "^127.0.0.1 localhost" /etc/hosts || echo "127.0.0.1 localhost" >> /etc/hosts

              echo "/etc/hosts fix complete"
              # Note: No need to restart pve-cluster - it will start automatically
              # after this service completes (via Before= and RequiredBy= directives)
          else
              echo "Error: Could not determine IP=${IP}, FQDN=${FQDN}, or HOSTNAME=${HOSTNAME}"
              exit 1
          fi

    - name: Create systemd service for /etc/hosts fix
      copy:
        dest: /etc/systemd/system/fix-proxmox-hosts.service
        mode: '0644'
        content: |
          [Unit]
          Description=Fix Proxmox /etc/hosts for non-loopback IP
          After=cloud-final.service
          Before=pve-cluster.service pveproxy.service pvedaemon.service pvestatd.service
          DefaultDependencies=no

          [Service]
          Type=oneshot
          ExecStart=/usr/local/bin/fix-proxmox-hosts.sh
          RemainAfterExit=yes

          [Install]
          RequiredBy=pve-cluster.service

    - name: Enable fix-proxmox-hosts service
      systemd:
        name: fix-proxmox-hosts.service
        enabled: yes
        daemon_reload: yes