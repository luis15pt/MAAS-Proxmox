---
- hosts: localhost
  connection: local
  become: true
  tasks:
    # CRITICAL: Configure /etc/hosts BEFORE installing Proxmox
    # Proxmox requires hostname to resolve to a non-loopback IP
    - name: Get default IPv4 address
      set_fact:
        pve_ip: "{{ ansible_default_ipv4.address }}"
        pve_hostname: "{{ ansible_hostname }}"
        pve_fqdn: "{{ ansible_fqdn }}"

    - name: Configure /etc/hosts for Proxmox installation
      lineinfile:
        dest: /etc/hosts
        # Remove any existing entries for this hostname/fqdn
        regexp: "^\\s*[0-9a-f:.]+\\s+(.*\\s)?({{ pve_fqdn | regex_escape() }}|{{ pve_hostname | regex_escape() }})(\\s+.*|\\s*)$"
        line: "{{ pve_ip }} {{ pve_fqdn }} {{ pve_hostname }}"
        backup: yes
      when: pve_ip is defined

    # Add Proxmox repository (compatible with Ansible 2.10.7)
    - name: Install gpg for apt_repository module
      apt:
        name: gpg
        state: present
        update_cache: true

    - name: Download Proxmox GPG key
      get_url:
        url: https://enterprise.proxmox.com/debian/proxmox-archive-keyring-trixie.gpg
        dest: /usr/share/keyrings/proxmox-archive-keyring.gpg
        mode: '0644'
        checksum: sha256:136673be77aba35dcce385b28737689ad64fd785a797e57897589aed08db6e45

    - name: Add Proxmox repository
      apt_repository:
        repo: "deb [signed-by=/usr/share/keyrings/proxmox-archive-keyring.gpg] http://download.proxmox.com/debian/pve trixie pve-no-subscription"
        state: present
        filename: proxmox

    - name: Add Ceph Squid repository
      apt_repository:
        repo: "deb [signed-by=/usr/share/keyrings/proxmox-archive-keyring.gpg] http://download.proxmox.com/debian/ceph-squid trixie no-subscription"
        state: present
        filename: ceph

    - name: Update package cache
      apt:
        update_cache: true

    # Preconfigure postfix to avoid interactive prompts during installation
    - name: Preconfigure postfix (no configuration)
      debconf:
        name: postfix
        question: postfix/main_mailer_type
        value: "No configuration"
        vtype: select

    - name: Preconfigure postfix mailname
      debconf:
        name: postfix
        question: postfix/mailname
        value: "{{ pve_fqdn }}"
        vtype: string

    # Install Proxmox kernel first
    - name: Install Proxmox kernel
      apt:
        name: proxmox-default-kernel
        state: present

    - name: Install Proxmox VE and dependencies
      apt:
        name:
          - proxmox-ve
          - postfix
          - open-iscsi
          - chrony
          - cloud-init
          - netplan.io
          - grub-cloud-amd64
          - grub-efi-amd64
          - ifupdown2
          - bridge-utils
        state: present

    # Remove os-prober (not needed for hypervisor)
    - name: Remove os-prober
      apt:
        name: os-prober
        state: absent

    # Remove standard Debian kernel (keep only Proxmox kernel)
    - name: Remove standard Debian kernel
      apt:
        name:
          - "linux-image-amd64"
          - "linux-image-6.12*"
        state: absent
        autoremove: yes
      ignore_errors: yes

    # Optional: Create debug user for console access (uncomment if needed)
    # Useful for debugging network issues when SSH key authentication fails
    # Default credentials: debug/proxmox123
    # - name: Create debug user with password
    #   user:
    #     name: debug
    #     password: "$6$7QbUPV7dKh9BXDTP$hqnif1xKJObYPOR3ZP2s2JeIp7Xvkubu2v1aIS5uFLEIVBXVBHaZStlQ9Kd.Ye89fWno7lNppsf3fs18W8C0k/"  # password: proxmox123
    #     shell: /bin/bash
    #     groups: sudo
    #     append: yes
    #     state: present
    #     create_home: yes

    # - name: Enable password authentication for console
    #   lineinfile:
    #     path: /etc/ssh/sshd_config
    #     regexp: '^#?PasswordAuthentication'
    #     line: 'PasswordAuthentication yes'
    #     state: present

    # CRITICAL: Disable systemd-networkd to prevent conflict with ifupdown2
    # Debian 13 cloud images come with systemd-networkd enabled by default
    # which conflicts with Proxmox's ifupdown2 network management
    - name: Disable and mask systemd-networkd service
      systemd:
        name: systemd-networkd
        enabled: no
        masked: yes
        daemon_reload: yes

    - name: Disable and mask systemd-networkd-wait-online service
      systemd:
        name: systemd-networkd-wait-online
        enabled: no
        masked: yes

    # CRITICAL: Disable systemd-resolved to match standard Proxmox behavior
    # Debian 13 cloud images include systemd-resolved which creates /etc/resolv.conf
    # as a symlink to 127.0.0.53. This prevents ifupdown2 from managing DNS properly.
    # Standard Proxmox installations do NOT use systemd-resolved.
    - name: Stop systemd-resolved service
      systemd:
        name: systemd-resolved
        state: stopped
      ignore_errors: yes

    - name: Disable and mask systemd-resolved service
      systemd:
        name: systemd-resolved
        enabled: no
        masked: yes

    - name: Remove systemd-resolved stub resolv.conf symlink
      file:
        path: /etc/resolv.conf
        state: absent
      ignore_errors: yes

    - name: Create placeholder resolv.conf file
      copy:
        dest: /etc/resolv.conf
        content: |
          # DNS will be configured during MAAS deployment
          # After deployment, can be changed via Proxmox web UI: Node → System → DNS
        mode: '0644'

    - name: Ensure networking service is enabled (ifupdown2)
      systemd:
        name: networking
        enabled: yes

    # Cloud-init configuration for Proxmox compatibility
    # Three-pronged approach to fix /etc/hosts:
    # 1. Disable cloud-init's manage_etc_hosts
    # 2. Modify the hosts template to remove 127.0.1.1 line
    # 3. Use bootcmd to dynamically add correct IP mapping

    - name: Override MAAS manage_etc_hosts for Proxmox compatibility
      copy:
        dest: /etc/cloud/cloud.cfg.d/99-proxmox.cfg
        content: |
          # Disable cloud-init hosts management for Proxmox compatibility
          # Proxmox requires hostname to resolve to actual IP, not 127.0.1.1
          manage_etc_hosts: false
          # CRITICAL: Completely disable cloud-init network management
          # Proxmox uses /etc/network/interfaces, not netplan
          network:
            config: disabled
        mode: '0644'

    - name: Disable network renderers in main cloud.cfg
      lineinfile:
        path: /etc/cloud/cloud.cfg
        regexp: '^\s*renderers:'
        state: absent

    - name: Disable network activators in main cloud.cfg
      lineinfile:
        path: /etc/cloud/cloud.cfg
        regexp: '^\s*activators:'
        state: absent

    - name: Remove network from cloud_init_modules list
      lineinfile:
        path: /etc/cloud/cloud.cfg
        regexp: '^\s*-\s*network\s*$'
        state: absent

    - name: Modify cloud-init hosts template to remove 127.0.1.1 line
      copy:
        dest: /etc/cloud/templates/hosts.debian.tmpl
        content: |
          ## template:jinja
          127.0.0.1 localhost

          # The following lines are desirable for IPv6 capable hosts
          ::1 ip6-localhost ip6-loopback
          fe00::0 ip6-localnet
          ff00::0 ip6-mcastprefix
          ff02::1 ip6-allnodes
          ff02::2 ip6-allrouters
        mode: '0644'

    - name: Add cloud-init bootcmd to fix /etc/hosts with actual IP
      copy:
        dest: /etc/cloud/cloud.cfg.d/98-proxmox-hosts.cfg
        content: |
          # Proxmox requires hostname to resolve to non-loopback IP
          # This bootcmd runs early in boot to add the correct IP mapping
          bootcmd:
            - |
              IP=$(ip -4 addr show | grep 'inet ' | grep -v '127.0.0.1' | head -1 | awk '{print $2}' | cut -d/ -f1)
              HOSTNAME=$(hostname -s)
              FQDN=$(hostname -f 2>/dev/null || echo "${HOSTNAME}.localdomain")
              if [ -n "$IP" ] && [ -n "$HOSTNAME" ]; then
                sed -i '/^127\.0\.1\.1/d' /etc/hosts
                grep -q "^${IP}" /etc/hosts || echo "${IP} ${FQDN} ${HOSTNAME}" >> /etc/hosts
              fi
        mode: '0644'

    # Note: Network bridge configuration (vmbr0) is handled by curtin-hooks
    # during MAAS deployment. The curtin-hooks script reads MAAS netplan
    # configuration and converts it to /etc/network/interfaces format with
    # a bridge for Proxmox VMs. Cloud-init configs baked into the image are
    # ignored by MAAS, so network configuration must happen via curtin.